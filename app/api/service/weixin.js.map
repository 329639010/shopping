{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\api\\service\\weixin.js"
    ],
    "names": [
        "crypto",
        "require",
        "md5",
        "rp",
        "module",
        "exports",
        "think",
        "Service",
        "login",
        "code",
        "fullUserInfo",
        "options",
        "method",
        "url",
        "qs",
        "grant_type",
        "js_code",
        "secret",
        "config",
        "appid",
        "sessionData",
        "JSON",
        "parse",
        "openid",
        "errno",
        "errcode",
        "errmsg",
        "data",
        "sha1",
        "createHash",
        "update",
        "rawData",
        "toString",
        "session_key",
        "digest",
        "signature",
        "wechatUserInfo",
        "decryptUserInfoData",
        "encryptedData",
        "iv",
        "e",
        "message",
        "sessionKey",
        "decoded",
        "_sessionKey",
        "Buffer",
        "from",
        "decipher",
        "createDecipheriv",
        "setAutoPadding",
        "final",
        "userInfo",
        "watermark",
        "err",
        "createUnifiedOrder",
        "payInfo",
        "WeiXinPay",
        "weixinpay",
        "mch_id",
        "partner_key",
        "Promise",
        "resolve",
        "reject",
        "body",
        "out_trade_no",
        "total_fee",
        "spbill_create_ip",
        "notify_url",
        "trade_type",
        "res",
        "return_code",
        "result_code",
        "returnParams",
        "parseInt",
        "Date",
        "now",
        "nonce_str",
        "prepay_id",
        "paramStr",
        "nonceStr",
        "package",
        "signType",
        "timeStamp",
        "paySign",
        "toUpperCase",
        "buildQuery",
        "queryObj",
        "sortPayOptions",
        "key",
        "Object",
        "keys",
        "sort",
        "payOptionQuery",
        "substring",
        "length",
        "signQuery",
        "queryStr",
        "md5Sign",
        "payNotify",
        "notifyData",
        "isEmpty",
        "notifyObj",
        "sign",
        "signString"
    ],
    "mappings": "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",
    "file": "..\\..\\..\\src\\api\\service\\weixin.js",
    "sourcesContent": [
        "const crypto = require('crypto');\r\nconst md5 = require('md5');\r\nconst rp = require('request-promise');\r\n\r\nmodule.exports = class extends think.Service {\r\n  async login(code, fullUserInfo) {\r\n    try {\r\n      // 获取 session\r\n      const options = {\r\n        method: 'GET',\r\n        url: 'https://api.weixin.qq.com/sns/jscode2session',\r\n        qs: {\r\n          grant_type: 'authorization_code',\r\n          js_code: code,\r\n          secret: think.config('weixin.secret'),\r\n          appid: think.config('weixin.appid')\r\n        }\r\n      };\r\n\r\n      let sessionData = await rp(options);\r\n      sessionData = JSON.parse(sessionData);\r\n      if (!sessionData.openid) {\r\n        return { errno: sessionData.errcode, errmsg: sessionData.errmsg, data: null };\r\n      }\r\n\r\n      // 验证用户信息完整性\r\n      const sha1 = crypto.createHash('sha1').update(fullUserInfo.rawData.toString() + sessionData.session_key).digest('hex');\r\n      if (fullUserInfo.signature !== sha1) {\r\n        return { errno: 400, errmsg: `signature 校验不一致`, data: null };\r\n      }\r\n\r\n      // 解析用户数据\r\n      const wechatUserInfo = await this.decryptUserInfoData(sessionData.session_key, fullUserInfo.encryptedData, fullUserInfo.iv);\r\n      return wechatUserInfo;\r\n    } catch (e) {\r\n      return { errno: 400, errmsg: '微信登录失败：' + e.message, data: null };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 解析微信登录用户数据\r\n   * @param sessionKey\r\n   * @param encryptedData\r\n   * @param iv\r\n   * @returns {Promise.<string>}\r\n   */\r\n  async decryptUserInfoData(sessionKey, encryptedData, iv) {\r\n    let decoded = '';\r\n    try {\r\n      const _sessionKey = Buffer.from(sessionKey, 'base64');\r\n      encryptedData = Buffer.from(encryptedData, 'base64');\r\n      iv = Buffer.from(iv, 'base64');\r\n      // 解密\r\n      const decipher = crypto.createDecipheriv('aes-128-cbc', _sessionKey, iv);\r\n      // 设置自动 padding 为 true，删除填充补位\r\n      decipher.setAutoPadding(true);\r\n      decoded = decipher.update(encryptedData, 'binary', 'utf8');\r\n      decoded += decipher.final('utf8');\r\n      const userInfo = JSON.parse(decoded);\r\n      if (userInfo.watermark.appid !== think.config('weixin.appid')) {\r\n        return { errno: 400, errmsg: 'watermark appid 错误', data: null };\r\n      }\r\n\r\n      // 解析后的数据格式\r\n      // { openId: 'oILjs0JEDIZzaWVc_sJW2k3fhp1k',\r\n      //   nickName: '明天',\r\n      //   gender: 1,\r\n      //   language: 'zh_CN',\r\n      //   city: 'Shenzhen',\r\n      //   province: 'Guangdong',\r\n      //   country: 'China',\r\n      //   avatarUrl: 'https://wx.qlogo.cn/mmopen/vi_32/9Otwibfa5VXR0ntXdlX84dibbulWLJ0EiacHeAfT1ShG2A7LQa2unfbZVohsWQlmXbwQGM6NnhGFWicY5icdxFVdpLQ/132',\r\n      //   watermark: { timestamp: 1542639764, appid: 'wx262f4ac3b1c477dd' } }\r\n      return { errno: 0, errmsg: '', data: userInfo };\r\n    } catch (err) {\r\n      return { errno: 500, errmsg: '解析用户数据错误：' + err.message, data: null };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 统一下单\r\n   * @param payInfo\r\n   * @returns {Promise}\r\n   */\r\n  createUnifiedOrder(payInfo) {\r\n    const WeiXinPay = require('weixinpay');\r\n    const weixinpay = new WeiXinPay({\r\n      appid: think.config('weixin.appid'), // 微信小程序appid\r\n      openid: payInfo.openid, // 用户openid\r\n      mch_id: think.config('weixin.mch_id'), // 商户帐号ID\r\n      partner_key: think.config('weixin.partner_key') // 秘钥\r\n    });\r\n    return new Promise((resolve, reject) => {\r\n      weixinpay.createUnifiedOrder({\r\n        body: payInfo.body,\r\n        out_trade_no: payInfo.out_trade_no,\r\n        total_fee: payInfo.total_fee,\r\n        spbill_create_ip: payInfo.spbill_create_ip,\r\n        notify_url: think.config('weixin.notify_url'),\r\n        trade_type: 'JSAPI'\r\n      }, (res) => {\r\n        if (res.return_code === 'SUCCESS' && res.result_code === 'SUCCESS') {\r\n          const returnParams = {\r\n            'appid': res.appid,\r\n            'timeStamp': parseInt(Date.now() / 1000) + '',\r\n            'nonceStr': res.nonce_str,\r\n            'package': 'prepay_id=' + res.prepay_id,\r\n            'signType': 'MD5'\r\n          };\r\n          const paramStr = `appId=${returnParams.appid}&nonceStr=${returnParams.nonceStr}&package=${returnParams.package}&signType=${returnParams.signType}&timeStamp=${returnParams.timeStamp}&key=` + think.config('weixin.partner_key');\r\n          returnParams.paySign = md5(paramStr).toUpperCase();\r\n          resolve(returnParams);\r\n        } else {\r\n          reject(res);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 生成排序后的支付参数 query\r\n   * @param queryObj\r\n   * @returns {Promise.<string>}\r\n   */\r\n  buildQuery(queryObj) {\r\n    const sortPayOptions = {};\r\n    for (const key of Object.keys(queryObj).sort()) {\r\n      sortPayOptions[key] = queryObj[key];\r\n    }\r\n    let payOptionQuery = '';\r\n    for (const key of Object.keys(sortPayOptions).sort()) {\r\n      payOptionQuery += key + '=' + sortPayOptions[key] + '&';\r\n    }\r\n    payOptionQuery = payOptionQuery.substring(0, payOptionQuery.length - 1);\r\n    return payOptionQuery;\r\n  }\r\n\r\n  /**\r\n   * 对 query 进行签名\r\n   * @param queryStr\r\n   * @returns {Promise.<string>}\r\n   */\r\n  signQuery(queryStr) {\r\n    queryStr = queryStr + '&key=' + think.config('weixin.partner_key');\r\n    const md5 = require('md5');\r\n    const md5Sign = md5(queryStr);\r\n    return md5Sign.toUpperCase();\r\n  }\r\n\r\n  /**\r\n   * 处理微信支付回调\r\n   * @param notifyData\r\n   * @returns {{}}\r\n   */\r\n  payNotify(notifyData) {\r\n    if (think.isEmpty(notifyData)) {\r\n      return false;\r\n    }\r\n\r\n    const notifyObj = {};\r\n    let sign = '';\r\n    for (const key of Object.keys(notifyData)) {\r\n      if (key !== 'sign') {\r\n        notifyObj[key] = notifyData[key][0];\r\n      } else {\r\n        sign = notifyData[key][0];\r\n      }\r\n    }\r\n    if (notifyObj.return_code !== 'SUCCESS' || notifyObj.result_code !== 'SUCCESS') {\r\n      return false;\r\n    }\r\n    const signString = this.signQuery(this.buildQuery(notifyObj));\r\n    if (think.isEmpty(sign) || signString !== sign) {\r\n      return false;\r\n    }\r\n    return notifyObj;\r\n  }\r\n};\r\n"
    ]
}